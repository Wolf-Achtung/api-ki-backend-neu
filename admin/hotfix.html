<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üîß Database Hotfix Tool</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#1e293b;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --primary:#3b82f6;
      --success:#22c55e;
      --error:#ef4444;
      --warning:#f59e0b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body{
      background:var(--bg);
      color:var(--text);
      font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
      height: 100%;
    }
    .container{
      max-width:920px;
      margin:0 auto;
      padding:40px 20px;
    }
    .card{
      background:var(--panel);
      border-radius:16px;
      padding:32px;
      box-shadow:0 4px 6px -1px rgba(0,0,0,.3), 0 2px 4px -2px rgba(0,0,0,.3);
      margin-bottom: 24px;
    }
    h1{
      font-size:32px;
      font-weight:700;
      margin-bottom:12px;
      color:var(--text);
    }
    h2{
      font-size:20px;
      font-weight:600;
      margin:32px 0 16px;
      color:var(--text);
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
      margin-bottom:32px;
    }
    .alert{
      padding:16px 20px;
      border-radius:12px;
      margin-bottom:24px;
      border-left:4px solid;
    }
    .alert-error{
      background:rgba(239,68,68,.1);
      border-color:var(--error);
      color:#fca5a5;
    }
    .alert-warning{
      background:rgba(245,158,11,.1);
      border-color:var(--warning);
      color:#fcd34d;
    }
    .alert-success{
      background:rgba(34,197,94,.1);
      border-color:var(--success);
      color:#86efac;
    }
    .alert-info{
      background:rgba(59,130,246,.1);
      border-color:var(--primary);
      color:#93c5fd;
    }
    label{
      display:block;
      margin:20px 0 8px;
      color:var(--text);
      font-weight:500;
      font-size:14px;
    }
    input, select, textarea{
      width:100%;
      padding:12px 16px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.1);
      background:rgba(0,0,0,.2);
      color:var(--text);
      font-size:14px;
      font-family:inherit;
      transition:border-color .2s;
    }
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--primary);
    }
    textarea{
      min-height:120px;
      font-family:'Monaco','Courier New',monospace;
      resize:vertical;
    }
    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-bottom:16px;
    }
    .button-group{
      display:flex;
      gap:12px;
      margin-top:24px;
    }
    button{
      padding:12px 24px;
      border-radius:10px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all .2s;
      font-family:inherit;
    }
    .btn-primary{
      background:var(--primary);
      color:white;
      flex:1;
    }
    .btn-primary:hover{ background:#2563eb; transform:translateY(-1px); }
    .btn-secondary{
      background:rgba(255,255,255,.1);
      color:var(--text);
      flex:1;
    }
    .btn-secondary:hover{ background:rgba(255,255,255,.15); }
    .btn-danger{
      background:var(--error);
      color:white;
    }
    .btn-danger:hover{ background:#dc2626; }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .log{
      background:rgba(0,0,0,.4);
      border-radius:12px;
      padding:20px;
      margin-top:24px;
      max-height:400px;
      overflow-y:auto;
      font-family:'Monaco','Courier New',monospace;
      font-size:13px;
      line-height:1.8;
    }
    .log-entry{
      margin:8px 0;
      padding:8px 12px;
      border-radius:6px;
    }
    .log-info{ color:#93c5fd; background:rgba(59,130,246,.1); }
    .log-success{ color:#86efac; background:rgba(34,197,94,.1); }
    .log-error{ color:#fca5a5; background:rgba(239,68,68,.1); }
    .log-warning{ color:#fcd34d; background:rgba(245,158,11,.1); }
    code{
      background:rgba(0,0,0,.3);
      padding:2px 6px;
      border-radius:4px;
      font-family:'Monaco','Courier New',monospace;
      font-size:13px;
    }
    .spinner{
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid rgba(255,255,255,.3);
      border-top-color:white;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-right:8px;
      vertical-align:middle;
    }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .hidden{ display:none !important; }
    .steps{
      list-style:none;
      counter-reset:step;
      margin:20px 0;
    }
    .steps li{
      counter-increment:step;
      padding:12px 0 12px 48px;
      position:relative;
      color:var(--muted);
    }
    .steps li::before{
      content:counter(step);
      position:absolute;
      left:0;
      top:8px;
      width:32px;
      height:32px;
      background:var(--primary);
      color:white;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üîß Database Hotfix Tool</h1>
      <p class="subtitle">Repariere Login-Probleme durch Schema-Migration</p>

      <div class="alert alert-error">
        <strong>‚ö†Ô∏è Problem:</strong> Login schl√§gt fehl mit "null value in column 'used' violates not-null constraint"
      </div>

      <div class="alert alert-success">
        <strong>‚úÖ L√∂sung:</strong> Hotfix <code>login_codes_v2</code> macht die 'used' Spalte optional und migriert zu 'consumed_at'
      </div>

      <h2>Anleitung</h2>
      <ol class="steps">
        <li>Backend URL eintragen (sollte automatisch erkannt werden)</li>
        <li>Admin Token aus Railway Environment Variables kopieren: <code>ADMIN_API_TOKEN</code></li>
        <li>Hotfix <strong>login_codes_v2</strong> ausw√§hlen (Standard)</li>
        <li>Button "Hotfix Ausf√ºhren" klicken</li>
        <li>Erfolgs-Meldung abwarten (~2-5 Sekunden)</li>
        <li>Login-Seite neu laden und testen</li>
      </ol>

      <label for="api">Backend API URL</label>
      <input id="api" 
             type="url" 
             placeholder="https://api-ki-backend-neu-production.up.railway.app"
             value="https://api-ki-backend-neu-production.up.railway.app">
      <small style="color:var(--muted);display:block;margin-top:4px">
        Die URL deines Railway Backend Services (ohne /api am Ende)
      </small>

      <label for="token">Admin Token</label>
      <input id="token" 
             type="password" 
             placeholder="Kopiere ADMIN_API_TOKEN aus Railway ENV">
      <small style="color:var(--muted);display:block;margin-top:4px">
        Zu finden in Railway ‚Üí Backend Service ‚Üí Variables ‚Üí ADMIN_API_TOKEN
      </small>

      <div class="row">
        <div>
          <label for="hotfix">Hotfix Ausw√§hlen</label>
          <select id="hotfix">
            <option value="login_codes_v2" selected>login_codes_v2 (EMPFOHLEN)</option>
            <option value="login_codes_reports_v1">login_codes_reports_v1 (Vollst√§ndig)</option>
          </select>
          <small style="color:var(--muted);display:block;margin-top:4px">
            <strong>login_codes_v2</strong>: Schnelle Reparatur des Login-Problems<br>
            <strong>login_codes_reports_v1</strong>: Komplette Schema-Migration
          </small>
        </div>
        <div>
          <label for="timeout">Timeout (Millisekunden)</label>
          <input id="timeout" type="number" value="30000" min="5000" max="120000" step="1000">
          <small style="color:var(--muted);display:block;margin-top:4px">
            Standard: 30 Sekunden (ausreichend f√ºr die meisten F√§lle)
          </small>
        </div>
      </div>

      <div class="button-group">
        <button id="apply" class="btn-primary">
          üöÄ Hotfix Ausf√ºhren
        </button>
        <button id="test" class="btn-secondary">
          üîç Verbindung Testen
        </button>
      </div>

      <div class="alert alert-warning" style="margin-top:24px">
        <strong>‚ö†Ô∏è Hinweis:</strong> Der Hotfix ist <strong>idempotent</strong> und kann mehrfach ausgef√ºhrt werden ohne Schaden anzurichten.
        Bei Fehlern einfach nochmal probieren.
      </div>

      <div id="log" class="log"></div>
    </div>

    <!-- F√ºr fortgeschrittene Nutzer -->
    <div class="card">
      <h2>‚öôÔ∏è Erweiterte Optionen (Optional)</h2>
      <p style="color:var(--muted);margin-bottom:16px">
        Nur verwenden wenn der Standard-Hotfix nicht funktioniert oder du eigenes SQL ausf√ºhren m√∂chtest.
      </p>

      <label for="sql">Eigenes SQL (Erfordert <code>ADMIN_ALLOW_RAW_SQL=1</code>)</label>
      <textarea id="sql" placeholder="-- Eigenes SQL hier einf√ºgen..."></textarea>

      <div class="button-group">
        <button id="send" class="btn-danger">
          ‚ö° Raw SQL Ausf√ºhren
        </button>
      </div>

      <div class="alert alert-warning" style="margin-top:16px">
        <strong>‚ö†Ô∏è Vorsicht:</strong> Raw SQL kann die Datenbank besch√§digen. Nur verwenden wenn du wei√üt was du tust!
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const log = $("#log");

    function addLog(msg, type = "info") {
      const entry = document.createElement("div");
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString("de-DE");
      entry.textContent = `[${timestamp}] ${msg}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function setLoading(btn, loading) {
      if (loading) {
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span> L√§dt...';
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.originalText || btn.textContent;
      }
    }

    async function callAPI(endpoint, body) {
      const api = $("#api").value.trim().replace(/\/$/, "");
      const token = $("#token").value.trim();

      if (!api) {
        addLog("‚ùå Bitte Backend URL eingeben", "error");
        return null;
      }

      if (!token) {
        addLog("‚ùå Bitte Admin Token eingeben", "error");
        return null;
      }

      const url = `${api}${endpoint}`;
      addLog(`üì° Request: ${endpoint}`, "info");

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Admin-Token": token
          },
          body: JSON.stringify(body)
        });

        const text = await response.text();
        let json = null;

        try {
          json = JSON.parse(text);
        } catch (e) {
          // Response ist kein JSON
        }

        if (!response.ok) {
          const error = json?.detail || text || response.statusText;
          addLog(`‚ùå Fehler ${response.status}: ${error}`, "error");
          return null;
        }

        addLog(`‚úÖ Erfolg: ${JSON.stringify(json || text)}`, "success");
        return json || text;

      } catch (error) {
        addLog(`‚ùå Netzwerk-Fehler: ${error.message}`, "error");
        return null;
      }
    }

    $("#test").addEventListener("click", async () => {
      const btn = $("#test");
      setLoading(btn, true);
      
      const api = $("#api").value.trim().replace(/\/$/, "");
      addLog(`üîç Teste Verbindung zu ${api}...`, "info");

      try {
        const response = await fetch(`${api}/healthz`);
        if (response.ok) {
          addLog(`‚úÖ Backend erreichbar (Status: ${response.status})`, "success");
        } else {
          addLog(`‚ö†Ô∏è Backend antwortet mit Status ${response.status}`, "warning");
        }
      } catch (error) {
        addLog(`‚ùå Verbindung fehlgeschlagen: ${error.message}`, "error");
      }

      setLoading(btn, false);
    });

    $("#apply").addEventListener("click", async () => {
      const btn = $("#apply");
      const name = $("#hotfix").value;
      const timeout = parseInt($("#timeout").value, 10);

      setLoading(btn, true);
      addLog(`üöÄ Starte Hotfix '${name}'...`, "info");

      const result = await callAPI("/api/admin/apply-hotfix", {
        name,
        statement_timeout_ms: timeout
      });

      if (result) {
        addLog(`‚ú® Hotfix erfolgreich! Dauer: ${result.duration_ms}ms`, "success");
        addLog(`‚úÖ Login sollte jetzt funktionieren. Bitte teste: ${$("#api").value.replace(/api.*$/, "")}make.ki-sicherheit.jetzt/login`, "success");
      }

      setLoading(btn, false);
    });

    $("#send").addEventListener("click", async () => {
      const btn = $("#send");
      const sql = $("#sql").value.trim();
      const timeout = parseInt($("#timeout").value, 10);

      if (!sql) {
        addLog("‚ùå Kein SQL eingegeben", "error");
        return;
      }

      if (!confirm("‚ö†Ô∏è Raw SQL ausf√ºhren? Dies kann die Datenbank besch√§digen!")) {
        return;
      }

      setLoading(btn, true);
      addLog(`‚ö° F√ºhre Raw SQL aus...`, "warning");

      const result = await callAPI("/api/admin/run-sql", {
        sql,
        statement_timeout_ms: timeout
      });

      if (result) {
        addLog(`‚ú® SQL erfolgreich ausgef√ºhrt! Dauer: ${result.duration_ms}ms`, "success");
      }

      setLoading(btn, false);
    });

    // Auto-populate API URL from current location
    if (window.location.hostname !== "localhost" && window.location.hostname !== "127.0.0.1") {
      const currentUrl = window.location.origin;
      // Versuche automatisch die richtige API URL zu erraten
      if (currentUrl.includes("railway.app")) {
        $("#api").value = currentUrl.replace("make-ki", "api-ki-backend-neu");
      }
    }

    addLog("üìã Bereit. Bitte Backend URL und Admin Token eingeben.", "info");
  </script>
</body>
</html>
