<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin – KI-Status-Report</title>
  <meta name="api-base" content="https://api-ki-backend-neu-production.up.railway.app/api">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/admin/admin.css">
</head>
<body>
  <main class="wrap">
    <div class="card">
      <div class="head">
        <h1 class="headline">Admin</h1>
        <div class="r">
          <a class="btn" href="/admin/detail.html">Detailansicht (leer)</a>
          <button id="logout" class="btn">Logout</button>
        </div>
      </div>
      <p class="notice">Überblick & Export</p>

      <section class="grid-3" id="stats">
        <div class="kpi-card"><h3>Users</h3><div class="val" id="k-users">–</div></div>
        <div class="kpi-card"><h3>Briefings</h3><div class="val" id="k-briefings">–</div></div>
        <div class="kpi-card"><h3>Analysen</h3><div class="val" id="k-analyses">–</div></div>
        <div class="kpi-card"><h3>Reports</h3><div class="val" id="k-reports">–</div></div>
      </section>

      <section class="card inner">
        <div class="toolbar">
          <input id="q" type="search" placeholder="Suche (E-Mail)" />
          <button id="reload" class="btn">Neu laden</button>
        </div>
        <table class="table" id="tbl">
          <thead><tr><th>ID</th><th>User</th><th>Datum</th><th>Aktionen</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
  (function(){
    function apiBase(){ const m=document.querySelector('meta[name="api-base"]'); return (m && m.content) || '/api'; }
    function token(){ try{ return localStorage.getItem('jwt') || ''; }catch(_){ return ''; } }
    async function api(path, opts){
      const headers = Object.assign({ 'Content-Type': 'application/json' }, (opts && opts.headers)||{});
      const t = token(); if (t) headers.Authorization = 'Bearer ' + t;
      const res = await fetch(apiBase() + path, Object.assign({}, opts, { headers }));
      const ct = res.headers.get('content-type') || '';
      const data = ct.includes('application/json') ? await res.json() : await res.text();
      if (!res.ok) throw new Error((data && data.detail) || res.statusText);
      return data;
    }
    function fmtDate(x){ if (!x) return '–'; try{ return new Date(x).toLocaleString('de-DE'); }catch(_){ return x; } }
    async function loadOverview(){
      const d = await api('/admin/overview');
      document.getElementById('k-users').textContent = d.totals.users;
      document.getElementById('k-briefings').textContent = d.totals.briefings;
      document.getElementById('k-analyses').textContent = d.totals.analyses;
      document.getElementById('k-reports').textContent = d.totals.reports;
    }
    async function loadBriefings(){
      const q = document.getElementById('q').value.trim();
      const d = await api('/admin/briefings' + (q ? ('?q=' + encodeURIComponent(q)) : ''));
      const tbody = document.getElementById('rows'); tbody.innerHTML='';
      d.rows.forEach(function(r){
        const tr = document.createElement('tr');
        const href = '/admin/detail.html?briefing=' + encodeURIComponent(r.id);
        tr.innerHTML = '<td>'+r.id+'</td>' +
                       '<td>'+ (r.user_id || '–') +'</td>' +
                       '<td>'+ fmtDate(r.created_at) +'</td>' +
                       '<td>' +
                         '<a class="btn-link" href="'+href+'">Ansehen</a> · ' +
                         '<a class="btn-link" href="'+apiBase()+'/admin/briefings/'+r.id+'/export.zip" target="_blank">Export (.zip)</a>' +
                       '</td>';
        tbody.appendChild(tr);
      });
    }
    document.getElementById('reload').addEventListener('click', function(){ loadBriefings().catch(console.error); });
    document.getElementById('logout').addEventListener('click', function(){ localStorage.removeItem('jwt'); location.href='/login.html'; });
    if (!token()) { location.href = '/login.html'; return; }
    loadOverview().catch(console.error);
    loadBriefings().catch(console.error);
  })();
  </script>
</body>
</html>
